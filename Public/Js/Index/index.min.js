/**
 * Created by Administrator on 05/06/2018.
 */

var partyStr='<div class="text-muted text-center more-login-area"> <span class="more-login-words">更多登录方式</span> </div><div class="widget-login mb15 text-center"><a href="User/oauth/type/qq"><span class="icon-sn-qq"></span></a><a href="User/oauth/type/weixin"><span class="icon-sn-weixin"></span></a><a href="User/oauth/type/weibo"><span class="icon-sn-weibo"></span></a><a href="User/oauth/type/google"><span class="icon-sn-google"></span></a><a href="User/oauth/type/github"><span class="icon-sn-github"></span></a><a href="User/oauth/type/linkedin"><span class="icon-sn-linkedin"></span></a><span id="loginShowMore" style="cursor: pointer" class="mb5"><span class="icon-sn-dotted"></span></span><a href="User/oauth/type/twitter"><span class="icon-sn-twitter"></span></a><a href="User/oauth/type/User/oauth/type/" class=" hidden"><span class="icon-sn-facebook"></span></a><a href="User/oauth/type/douban" class=" hidden"><span class="icon-sn-douban"></span></a> </div><div class="form-group clearfix">{loRore}</div><p class="text-muted text-center mb15">登录即表示你同意网站的<a href="./Togs/index" target="_blank">《服务条款》</a></p>';

var loginStr='<div class="Modal-content"><div class="row bg-white login-modal"><div class="col-md-12 login-wrap"><form id="login" action="User/login" method="POST" role="form" class="mt15"><div class="form-group hidden"><input type="text" class="form-control" name="remember" value="1" autocomplete="off"></div><div class="form-group"><label for="username" class="control-label"> Email</label><input type="text" class="form-control" name="username" tabindex="1" required="" placeholder="Email" autocomplete="off"></div><div class="form-group"><label class="control-label">密码</label><span class="pull-right"><a href="/blog/index.php/User/forgot.html" tabindex="4">忘记密码</a></span><input type="password" class="form-control" name="password" tabindex="2" required="" placeholder="请输入密码"></div><div class="form-group clearfix"><button type="submit" class="btn-block btn btn-primary pull-right pl20 pr20" tabindex="3" onclick="">登录 </button></div></form>{partyStr}</div></div></div>';
var regisStr='<div class="modal-body"><div class="sfModal-content"><div class="row bg-white login-modal"><div class="col-md-12 login-wrap"><form action="User/register" method="POST" role="form" class="mt15" id="register" ><div class="form-group"><label for="name" class="control-label">你的名字</label><input type="text" class="form-control" name="nickname" required="" placeholder="真实姓名或常用昵称"></div><div class="form-group"><label for="mail" class="control-label"> Email</label><input type="email" class="form-control email" name="email" placeholder="邮箱" required="" id="login-name"></div><input type="text" class="hidden" name="register_type" value="email"><div class="form-group"><div class="phone-register-only hidden"><div class="captchaInput mb10"><input type="text" class="form-control" name="verify" placeholder="右侧的验证码" style="width:50%; display: inline; margin-right: 15px;" required=""><span class="mt10"><a id="loginReloadCaptcha" href="javascript:void(0)"><img  class="img-rounded" src="{verifyImg}" alt="<{$Think.lang.verify}>" onclick="this.src=this.src+\'?\'+Math.random()"  class="cap" width="128px" height="34px"></a></span></div><div class="input-group" ><input name="code" type="text" class="form-control js-user-login__maile-code-value" placeholder="Email验证码" required="" style="width:50%; display: inline; margin-right: 15px;"><span class="mt10"><button class="btn btn-default js-user-login__maile-vaild-btn" style="width:96px;" type="button">获取验证码</button></span></div></div></div><div class="form-group"><label for="password" class="control-label">密码</label><input type="password" class="form-control" name="password" required="" placeholder="不少于 6 位的密码"></div><div class="form-group clearfix"><button type="submit" class="btn-block btn btn-primary pl20 pr20 pull-right" >注册 </button></div>{loRore}</form></div></div></div></div>'

$(".header-search input").on("focus", function(e) {
    e.preventDefault(),
        $(".blog-header").addClass("search-open")
})
$(".header-search input").on("blur", function(e) {
    e.preventDefault(),
    $(".blog-header").removeClass("search-open")
})
$('.entypo-wechart').on({
    mouseenter:function(){
        $("#popover192361").show();
    },
    mouseleave:function(){
        $("#popover192361").hide();
    }
});
$('.opts__item.user').on({
    mouseenter:function(){
        $(".dropdown-avatar-menu").removeClass('hidden');
    },
    mouseleave:function(){
        $(".dropdown-avatar-menu").addClass('hidden');
    }
});
function checkLogin() {
    var a =new Array();
    $("#login")[0].addEventListener('submit',function(t){
        t.preventDefault();
        var o = {},
            r = $(this).closest("form").find("input:not(.hide,hidden)");
        r.each(function() {
            var t = $(this)
                , n = t.attr("name")
                , a = t.val();
            o[n] = a
        });
        if(a.length>0){
            for(i=0;i<a.length;i++){
                $('[name='+a[i]+']').parent().removeClass("has-error")
                $('[name='+a[i]+']').siblings("[class='help-block err']").remove();
            }
            a.length=0;
        }

        if(o.password.length<6){
            $('[name="password"]').parent().append('<span class="help-block err">密码不符合规范，请大于6位</span>')
            $('[name="password"]').parent().addClass("has-error");
            a.push('password')
            return false;
        }
        $.post("/blog/index.php/User/login", o, function(e) {
            e=JSON.parse(e);
            if(e.status!=200){
                !$('[name='+e.cap.name+']').siblings("[class='help-block err']").length ? $('[name='+e.cap.name+']').parent().append('<span class="help-block err">'+e.cap.value+'</span>'):$('[name='+e.cap.name+']').siblings("[class='help-block err']")[0].innerHTML = e.cap.value;
                $('[name='+e.cap.name+']').parent().addClass("has-error");
                a.push(e.cap.name);
                return;
            }else{
               window.location.href="/blog/index.php/Index/index.html";
            }

        })
    });
}
function checkRegister() {
    $("#login-name").on("input", function(t) {
        var n = /^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/;
        n.test(t.target.value.trim()) ? ($(".phone-register-only").removeClass("hidden")) : ($(".phone-register-only").addClass("hidden"))

    });
    $("body").on("click", ".js-user-login__maile-vaild-btn", function() {
        var t = $(this)
            , n = 60
            , a = void 0
            , i = function() {
            n > 1 ? (n--,
                    t.text(n + "s")) : (clearInterval(a),
                    t.text("获取验证码"),
                    t.prop("disabled", !1))
        }
            , o = {}
            , r = $(this).closest("form").find("input:not(.hide,hidden)");
        r.each(function() {
            var t = $(this)
                , n = t.attr("name")
                , a = t.val();
            o[n] = a
        }),
            t.prop("disabled", !0);
        a = setInterval(i, 1e3);

        $.post("/blog/index.php/Index/Api/sendMail", o, function(e) {
            e=JSON.parse(e);
            if(e.status!=200){
                !$("[name='email']").next().length ? $("[name='email']").after('<span class="help-block err">'+e.cap+'</span>'):$("[name='email']").next()[0].innerHTML = e.cap;
                $("[name='email']").parent().addClass("has-error")
                t.prop("disabled", !1);
                clearInterval(a);
                t.text("获取验证码");
                return;
            }
            $("[name='email']").parent().hasClass("has-error") ? ($("[name='email']").parent().removeClass("has-error"),$("[name='email']").siblings("[class='help-block err']").remove()):''

        })
    })
    var a =new Array();
    $("#register")[0].addEventListener('submit',function(t){
        t.preventDefault();
        var o = {},
            r = $(this).closest("form").find("input:not(.hide,hidden)");
        r.each(function() {
            var t = $(this)
                , n = t.attr("name")
                , a = t.val();
            o[n] = a
        });
        if(a.length>0){
            for(i=0;i<a.length;i++){
                $('[name='+a[i]+']').parent().removeClass("has-error")
                $('[name='+a[i]+']').siblings("[class='help-block err']").remove();
            }
            a.length=0;
        }

        if(o.verify.length!=4){
            $('[name="verify"]').parent().append('<span class="help-block err">图像验证码不正确</span>')
            $('[name="verify"]').parent().addClass("has-error");
            a.push('verify')
            return false;
        }
        if(o.code.length!=4){
            $('[name="code"]').parent().append('<span class="help-block err">Email验证码</span>')
            $('[name="code"]').parent().addClass("has-error");
            a.push('code')
            return false;
        }
        if(o.password.length<6){
            $('[name="password"]').parent().append('<span class="help-block err">密码不符合规范，请大于6位</span>')
            $('[name="password"]').parent().addClass("has-error");
            a.push('password')
            return false;
        }
        $.post("/blog/index.php/User/register", o, function(e) {
            e=JSON.parse(e);
            if(e.status!=200){
                $('.img-rounded').click();
                for(i=0;i<e.cap.length;i++){
                    !$('[name='+e.cap[i].name+']').siblings("[class='help-block err']").length ? $('[name='+e.cap[i].name+']').parent().append('<span class="help-block err">'+e.cap[i].value+'</span>'):$('[name='+e.cap[i].name+']').siblings("[class='help-block err']")[0].innerHTML = e.cap[i].value;
                    $('[name='+e.cap[i].name+']').parent().addClass("has-error");
                    a.push(e.cap[i].name);
                }
                return;
            }else{
                window.location.reload();
            }

        })
    });
}
$("body").on("click", ".Register", function(e) {
    e.preventDefault();
    $(".modal").show();

    str= loginStr.replace("{partyStr}",partyStr).replace("{loRore}",'<a class="btn-block btn btn-default pull-right pl20 pr20 SFLogin" onclick="$(\'.Login\').click()"> 注册新账号 </a>');
    $(".modal-body").html(str);
    $(".in").addClass("modal-backdrop");
    $(".modal-title").html("登录");
    $("#loginShowMore").on("click", function(e) {
        $(this).hide();
        $(this).siblings().removeClass("hidden")
    })
    checkLogin()
})
$("body").on("click", ".Login", function(e) {
    e.preventDefault();
    $(".modal").show();
    str= regisStr.replace('{verifyImg}',verifyImg).replace("{partyStr}",partyStr).replace("{loRore}",'<a class="btn-block btn btn-default pull-right pl20 pr20" onclick="$(\'.Register\').click()">已有账号登录</a>')
    $(".modal-body").html(str);
    $(".modal-footer ").removeClass("hide");
    $(".modal-footer ").html('<button type="button" class="btn btn-default" data-dismiss="modal">继续转载</button><button type="button" class="btn btn-primary done-btn">用头条发布</button>');
    $(".in").addClass("modal-backdrop");
    $(".modal-title").html("注册");
    $("#loginShowMore").on("click", function(e) {
        $(this).hide();
        $(this).siblings().removeClass("hidden")
    })
    checkRegister();

})
$(".close").on("click", function(e) {
   $(".modal").hide();
   $(".in").removeClass("modal-backdrop");
   $(".modal-title").html("");
    $(".modal-body").html('');

})

$("#backtop").click(function() {
    return $("body,html").animate({
        scrollTop: 0
    }),
        !1
}),
$(document).scroll(function() {
        $(this).scrollTop() > 720 ? $("#backtop").removeClass("hidden") : $("#backtop").addClass("hidden")
})
$('.btn\.btn-default\.dropdown-toggle').click(function(){
    if($(this).attr('aria-expanded') =="true"){
        $(this).attr('aria-expanded',"false")
        $(this).parent().removeClass("open")
    }else{
        $(this).attr('aria-expanded',"true")
        $(this).parent().addClass("open")

    }
});
d = function() {
    $(".opts__item--message").removeClass("hide"),
        $.get("/api/notifications", function(t) {
            var n, a, i, o;
            t.status || (t.data = null != (a = t.data) ? a : [],
                i = {
                    data: t.data,
                    unread: {
                        general: _.filter(t.data.general, function(e) {
                            return 0 === parseInt(e.viewed)
                        }).length,
                        ranked: _.filter(t.data.ranked, function(e) {
                            return 0 === parseInt(e.viewed)
                        }).length,
                        followed: _.filter(t.data.followed, function(e) {
                            return 0 === parseInt(e.viewed)
                        }).length,
                        comment: _.filter(t.data.comment, function(e) {
                            return 0 === parseInt(e.viewed)
                        }).length
                    }
                },
                o = _.reduce(i.unread, function(e, t) {
                    return e + t
                }, 0),
            o > 0 && $(".opts__item--message .message-ingore-all").removeClass("hide"),
                $("#messageGeneral").html(_.template($("#messageGeneralTpl").html())(i.data)),
                $("#messageComment").html(_.template($("#messageCommentTpl").html())(i.data)),
                $("#messageRanked").html(_.template($("#messageRankedTpl").html())(i.data)),
                $("#messageFollowed").html(_.template($("#messageFollowedTpl").html())(i.data)),
                $(".opts__item--message-loading").remove(),
                n = {},
                $(".mCustomScrollbar-message").mCustomScrollbar({
                    scrollInertia: 0,
                    callbacks: {
                        onScroll: function() {
                            var t, a, i;
                            if (i = this.mcs.topPct,
                                    a = e(this).data("proto"),
                                    n[a] = n[a] || 2,
                                i > 55 && n[a] !== -1) {
                                if (console.log(a, i, "ajax page " + n[a]),
                                        t = "/api/notifications?type=" + a + "&page=" + n[a],
                                    window.__api === t)
                                    return;
                                return window.__api = t,
                                    e.get(t, function(t) {
                                        var i, o;
                                        if (!t.status)
                                            return i = t.data[a],
                                                i.length > 0 ? (o = _.template($("#item--" + a).html())(t.data),
                                                        $(".tab-pane.active .mCSB_container").append(o),
                                                        n[a]++) : n[a] = -1
                                    })
                            }
                        }
                    }
                }))
        })
}
$(".dropdown-toggle-message").on("click", function(t) {
    var n;
    return t.preventDefault(),
        n = $(".opts__item--message"),
    "undefined" != typeof v && v.emit("read"),

        "none" !== n.css("display") ? n.addClass("hide") : (d(),
                $.get("/api/notifications/viewed", function(t) {
                    var n;
                    if (n = null,
                            !t.status)
                        return _.each(t.data, function(t, a) {
                            if (t)
                                return n ? (n = $(".notice-dot-" + a),
                                        n.removeClass("hide"),
                                        n.removeClass("notice-dot--special")) : (n = $(".notice-dot-" + a),
                                        n.addClass("notice-dot--special"),
                                        n.closest("a[role='tab']").trigger("click"))
                        })
                }))
})
$(".opts__item--message a[role='tab']").on("click", function(t) {
    t.preventDefault();
    $(".opts__item--message .active").not(".btn").removeClass("active");
    $(this).addClass("active");
    $(this).parent().addClass("active");
    $($(this).attr('href')).addClass("active");


})
$("body").on("click", function(t) {
    $('.btn\.btn-default\.dropdown-toggle').attr('aria-expanded') =="true" &&0 === $(t.target).parents(".btn-group\.open").length&&   $('.btn\.btn-default\.dropdown-toggle').attr('aria-expanded',"false")&&$('.btn\.btn-default\.dropdown-toggle').parent().removeClass("open");
    "none" !== $(".opts__item--message").css("display") && 0 === $(t.target).parents(".message").length && $(".opts__item--message").addClass("hide")
})
function WAl(AlertStr) {
    return   $AlertL=$('<div id="myAlert" class="alert alert-warning"><a href="#" class="close" data-dismiss="alert" onclick="$(this).parent().remove()">&times;</a><strong>警告！</strong>'+AlertStr+'</div>');
};

function SAl(AlertStr) {
    return   $AlertL=$('<div id="myAlert" class="alert alert-success"><a href="#" class="close" data-dismiss="alert" onclick="$(this).parent().remove()">&times;</a><strong>成功！</strong>'+AlertStr+'</div>');
};
var getData = true;
var getPage = 1;
/**
 * 时间戳转几天前
 * @param time
 * @return bool|string
 */
function timest() {
    var tmp = Date.parse( new Date() ).toString();
    tmp = tmp.substr(0,10);
    return tmp;
}
function mdate(timespan)
{
    timespan = parseInt(timespan+100);
    var dateTime = new Date(timespan);

    var year = dateTime.getFullYear();
    var month = dateTime.getMonth() + 1;
    var day = dateTime.getDate();
    var hour = dateTime.getHours();
    var minute = dateTime.getMinutes();
    var second = dateTime.getSeconds();
    var now = new Date();
    var now_new = Date.parse(now.toDateString());  //typescript转换写法

    var milliseconds = 0;
    var timeSpanStr;

    milliseconds = now_new - timespan;

    if (milliseconds <= 1000 * 60 * 1) {
        timeSpanStr = '刚刚';
    }
    else if (1000 * 60 * 1 < milliseconds && milliseconds <= 1000 * 60 * 60) {
        timeSpanStr = Math.round((milliseconds / (1000 * 60))) + '分钟前';
    }
    else if (1000 * 60 * 60 * 1 < milliseconds && milliseconds <= 1000 * 60 * 60 * 24) {
        timeSpanStr = Math.round(milliseconds / (1000 * 60 * 60)) + '小时前';
    }
    else if (1000 * 60 * 60 * 24 < milliseconds && milliseconds <= 1000 * 60 * 60 * 24 * 15) {
        timeSpanStr = Math.round(milliseconds / (1000 * 60 * 60 * 24)) + '天前';
    }
    else if (milliseconds > 1000 * 60 * 60 * 24 * 15 && year == now.getFullYear()) {
        timeSpanStr = month + '-' + day + ' ' + hour + ':' + minute;
    } else {
        timeSpanStr = year + '-' + month + '-' + day + ' ' + hour + ':' + minute;
    }
    return timeSpanStr;
}
window.onscroll = function(){
    var t = document.documentElement.scrollTop || document.body.scrollTop;
    var h = document.body.scrollHeight;
    if( t >= (h-1300) &&  getData) {
        getData = false;
        getPage++;
        var o = {};
        o['p']=getPage;

        $.post(location.pathname ,o, function(e) {
            e=JSON.parse(e);
            if(e.status!=200){
                $('#btn-load-more').removeClass("hidden")
                $('#btn-loading').addClass("hidden")
            }else{
                getData = true;
                str = '';
                for(i=0;i<e.data.length;i++){
                    str+='<div class="news-item stream__item clearfix" data-id="'+e.data[i].id+'">\n' +
                        '                            <div class="news__item-avatar"><a href="/blog/index.php/User/index/user/'+e.data[i].pageurl+'.html"><img class="avatars-img" src="'+e.data[i].head+'"></a></div>\n' +
                        '                            <div class="news__item-info">\n' +
                        '                                <div class="mb6">\n' +
                        '                                    <h4 class="news__item-title mt0"><a class="mr10" target="_blank" href="/blog/index.php/Article/index/id/'+e.data[i].id+'.html">'+e.data[i].title+'</a></h4>\n' +
                        '                                </div>\n' +
                        '                                <p class="news__item-meta"><a href="/blog/index.php/User/index/user/\'+e.data[i].pageurl+\'.html">'+e.data[i].nickname+'</a><span class="dot">·</span><span>'+mdate(e.data[i].date)+'</span><span class="pull-right hidden-xs hidden-sm"><i class="fa fa-thumbs-up" aria-hidden="true"></i> '+e.data[i].thumbs+'</span></p>\n' +
                        '                            </div>\n' +
                        '                        </div>';
                }
                $(".news-list").append(str);
            }
        })
    }
}
function  one(a, b, c, d) {
    return this.on(a, b, c, d, 1)
}
var sliding = false;
function slideRoll(to,from){
    sliding = !0;
    var toEle = $('.carousel-inner>a').eq(to);
    var fromeEle = $('.carousel-inner>a').eq(from);
    $('.carousel-indicators>li').eq(to).addClass('active');
    $('.carousel-indicators>li').eq(from).removeClass('active');

    if(to > from){
        e= 'next';
        d = 'left';
    }else{
        e= 'prev';
        d= 'right';
    }
    toEle.addClass(e);
    toEle[0].offsetWidth;
    fromeEle.addClass(d);
    toEle.addClass(d);

    fromeEle.one("webkitTransitionEnd",function(){
        toEle.removeClass([e, d].join(" ")).addClass("active");
        fromeEle.removeClass(["active",  d].join(" "))
        sliding = !1;
    })
}

$(".carousel-indicators>li").on('click',(e)=>{
    e.preventDefault()
   var to =$(e.target).attr("data-slide-to");

   if(!sliding && to!=$('.carousel-indicators>.active').index()){
       slideRoll(to,$('.carousel-indicators>.active').index())
   }


})
var slideT=''
function slideTimer(){
     slideT=setInterval(function(){
        if(!sliding ){
            from=$(".carousel-inner>.active").index();
            if(from>3){
                to =0;
            }else{
                to =$(".carousel-inner>.active").index()+1;
            }
            slideRoll(to,from)
        }
    },2000)
}
$(window).on("load", function() {

    slideTimer()
    $("#mm_124884735_33830642_184038395").hover(function (){

        window.clearInterval(slideT);
    },function (){
        slideTimer()
    });
})

















